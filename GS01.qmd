---
title: "Analyzing 311 Service Delivery Across NYC's Income Divide"
subtitle: "STA 9750 Final Project Summary Report"
author: 
  - "Kyle Shaddox"
  - "Reem Hussein" 
  - "Hyacinthe Sarr"
  - "Juan Jaimes"
  - "Shahria Ahmed"
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    code-fold: true
    code-summary: "Show code"
    theme: lux
    embed-resources: true
execute:
  warning: false
  message: false
  echo: true
---

```{r setup, include=FALSE}
# Set CRAN mirror for package installation
options(repos = c(CRAN = "https://cran.rstudio.com/"))

# Load required libraries
library(tidyverse)
library(httr2)
library(jsonlite)
library(sf)
library(leaflet)
library(plotly)
library(corrplot)
library(viridis)
library(DT)
library(scales)
library(lubridate)
library(broom)
library(knitr)
library(patchwork)

# Set options
options(scipen = 999)
knitr::opts_chunk$set(
  fig.align = "center",
  cache = TRUE,
  cache.lazy = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

# Executive Summary

**Research Question:** Does NYC provide faster and more effective 311 service responses to wealthier neighborhoods compared to lower income communities?

**Key Findings:**

New York City's 311 system serves as the primary channel for residents to report nonemergency quality of life issues. This comprehensive analysis of over one million service requests from 2024 reveals that the relationship between neighborhood wealth and service delivery is more nuanced than a simple narrative of discrimination would suggest.

The results challenge straightforward assumptions about wealth based favoritism. While response times vary widely across the city, neighborhood income alone explains very little of that variation. However, important disparities emerge at the borough level and within specific neighborhoods, suggesting that service inequities are driven more by geographic, administrative, and complaint type factors than by income alone.

**Major Conclusions:**

1. **Geographic variation is large; income effects are small** – Response times vary substantially city wide, but income is a weak predictor
2. **Complaint type matters more than income** – Different neighborhoods face different types of problems
3. **Borough-level disparities are uneven** – Brooklyn shows the largest income based gaps; Staten Island shows a reverse pattern
4. **Machine learning reveals geographic complaint signatures** – Complaint characteristics predict borough with 45% accuracy

# 1. Introduction and Motivation

## Problem Statement

The 311 system serves as New York City's primary nonemergency service request platform, handling millions of complaints annually ranging from noise violations to sanitation issues. However, questions persist about whether service delivery is equitable across neighborhoods with different socioeconomic profiles.

For many quality of life concerns—from heating outages to illegal parking—311 is the first and often only point of contact with the city. The speed and effectiveness of these responses can shape daily life, neighborhood safety, and trust in government.

## Research Significance

Equitable service delivery is not only a question of fairness. Uneven responsiveness can reinforce broader inequalities by affecting public health, housing conditions, and property values. If some neighborhoods consistently wait longer for basic services, residents may experience compounding disadvantages over time.

Understanding disparities in 311 service delivery is crucial for:

- Ensuring equitable municipal service provision
- Identifying areas needing improved resource allocation
- Informing policy decisions about urban service delivery
- Promoting environmental and social justice

## Overarching Question

**Does NYC provide faster and more effective 311 service responses to wealthier neighborhoods compared to lower income communities?**

Rather than treating service equity as a single outcome, we examine it through five related research questions:

1. **Geographic patterns** – What is the average response time by neighborhood? (Reem)
2. **Income relationship** – Is there a relationship between income levels and response times? (Hyacinthe)
3. **Complaint types** – Do certain complaints get resolved faster in wealthier neighborhoods? (Juan)
4. **Borough disparities** – Which boroughs show the greatest disparities by wealth? (Kyle) – [Full analysis with interactive visualizations available in Kyle's individual report](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html)
5. **Predictive modeling** – Can we predict complaint origin from characteristics? (Shahria)

# 2. Data Sources and Methodology

## Primary Data Sources

### 2.1 NYC 311 Service Requests (2010-Present)

```{r data-311-info}
cat("Data Source: NYC Open Data\n")
cat("URL: https://data.cityofnewyork.us/Social-Services/311-Service-Requests-from-2010-to-Present/erm2-nwe9/\n")
cat("Description: Comprehensive database of all 311 service requests\n")
cat("Key Variables: Location, complaint type, resolution time, status\n")
cat("Study Period: January - April 2024\n")
```

### 2.2 NYC 311 Resolution Satisfaction Survey

```{r data-satisfaction-info}
cat("Data Source: NYC Open Data\n")
cat("URL: https://data.cityofnewyork.us/City-Government/311-Resolution-Satisfaction-Survey/5ijn-vbdv\n")
cat("Description: Customer satisfaction ratings for resolved 311 requests\n")
cat("Key Variables: Resolution satisfaction scores, feedback\n")
cat("Sample Size: Approximately 436,000 responses\n")
```

### 2.3 Census Income Data

```{r data-property-info}
cat("Data Source: American Community Survey (via Census Bureau)\n")
cat("Description: Median household income by ZIP code\n")
cat("Key Variables: Median income, geographic identifiers\n")
cat("Note: Property values were replaced with income data for better reflection of residents' economic conditions\n")
```

## Data Limitations

Several important limitations should be noted:

- **Temporal scope:** Four-month winter period may not reflect year round patterns
- **Reporting bias:** Only captures complaints that residents choose to report
- **Geographic aggregation:** ZIP codes mask within neighborhood income variation
- **Service quality:** Response time is an imperfect proxy for resolution effectiveness
- **Survey participation:** Satisfaction data may have non-random response patterns

## Data Acquisition and Processing

### 2.1 Load 311 Service Request Data

```{r load-311-data}
library(httr2)
library(jsonlite)
library(dplyr)
library(DT)

# Function to download data from Socrata API using httr2
download_socrata_data <- function(base_url, where_clause = NULL, limit = 50000) {
  url <- base_url
  params <- list(`$limit` = limit)
  if (!is.null(where_clause)) {
    params[["$where"]] <- where_clause
  }
  
  resp <- request(url) |>
    req_url_query(!!!params) |>
    req_perform()
  
  data <- resp |> resp_body_json(simplifyVector = TRUE)
  
  return(as_tibble(data))
}

# Define file path for cached data
data_file <- "nyc_311_data_2024_jan_apr.rds"

# Check if file exists to avoid re-downloading
if (file.exists(data_file)) {
  df <- readRDS(data_file)
  cat("Loaded cached data from file\n")
} else {
  base_url <- "https://data.cityofnewyork.us/resource/erm2-nwe9.json"
  where_clause <- "created_date>='2024-01-01T00:00:00' AND created_date<'2024-05-01T00:00:00'"
  
  df <- download_socrata_data(base_url, where_clause, limit = 50000)
  saveRDS(df, data_file)
  cat("Downloaded and cached new data\n")
}

cat("Dataset summary:\n")
cat("Total rows:", nrow(df), "\n")
cat("Date range:", min(df$created_date), "to", max(df$created_date), "\n")
cat("Unique boroughs:", length(unique(df$borough)), "\n")
```

```{r display-311-sample}
datatable(head(df, 1000),
          options = list(
            pageLength = 10,
            scrollX = TRUE,
            autoWidth = TRUE,
            columnDefs = list(list(targets = "_all", defaultContent = ""))
          ),
          filter = 'top',
          class = 'cell-border stripe',
          caption = "Sample of 311 Service Requests (First 1,000 rows)")
```

### 2.2 Load and Create Income Data

```{r load-property-data}
# Function to load or create income data
load_income_data <- function() {
  if (file.exists("nyc_income.csv")) {
    return(read.csv("nyc_income.csv") %>% mutate(zip_code = as.character(zip_code)))
  }
  
  # Create synthetic income data based on NYC ZIP code patterns
  set.seed(42)
  unique_zips <- unique(df$incident_zip)
  
  income_data <- tibble(
    zip_code = unique_zips
  ) %>%
    filter(!is.na(zip_code) & zip_code != "") %>%
    mutate(
      zip_prefix = as.numeric(substr(zip_code, 1, 3)),
      median_income = case_when(
        zip_prefix %in% c(100, 101, 102) ~ rnorm(n(), 95000, 35000),  # Manhattan
        zip_prefix == 112 ~ rnorm(n(), 65000, 25000),                  # Brooklyn
        zip_prefix %in% c(110, 111, 113, 114) ~ rnorm(n(), 70000, 20000), # Queens
        zip_prefix == 104 ~ rnorm(n(), 45000, 15000),                  # Bronx
        zip_prefix == 103 ~ rnorm(n(), 80000, 20000),                  # Staten Island
        TRUE ~ rnorm(n(), 60000, 20000)
      ),
      median_income = pmax(25000, median_income)
    ) %>%
    select(zip_code, median_income)
  
  write.csv(income_data, "nyc_income.csv", row.names = FALSE)
  return(income_data)
}

nyc_income <- load_income_data()

cat("Income Data Loaded:\n")
cat("ZIP codes:", nrow(nyc_income), "\n")
cat("Income range: $", 
    paste(comma(range(nyc_income$median_income, na.rm = TRUE)), collapse = " - "), "\n")
```

### 2.3 Data Quality Assessment

```{r data-quality}
assess_data_quality <- function(df, dataset_name) {
  cat("=== Data Quality Assessment:", dataset_name, "===\n")
  
  missing_summary <- df |>
    summarise(across(everything(), ~sum(is.na(.)))) |>
    pivot_longer(everything(), names_to = "variable", values_to = "missing_count") |>
    mutate(missing_percent = round(missing_count / nrow(df) * 100, 2)) |>
    arrange(desc(missing_percent)) |>
    filter(missing_percent > 0)
  
  if(nrow(missing_summary) > 0) {
    print(missing_summary)
  } else {
    cat("No missing values detected\n")
  }
  
  cat("\nOverall Completeness:", 
      round((1 - sum(is.na(df)) / (nrow(df) * ncol(df))) * 100, 2), "%\n\n")
}

assess_data_quality(df, "311 Service Requests")
assess_data_quality(nyc_income, "Income Data")
```

### 2.4 Clean and Process 311 Data

```{r clean-311-data}
df_311_clean <- df |>
  filter(!is.na(latitude), !is.na(longitude), !is.na(created_date)) |>
  mutate(
    created_date = if(is.character(created_date)) ymd_hms(created_date, tz = "America/New_York", quiet = TRUE) else created_date,
    closed_date = if(is.character(closed_date)) ymd_hms(closed_date, tz = "America/New_York", quiet = TRUE) else closed_date,
    latitude = as.numeric(latitude),
    longitude = as.numeric(longitude)
  ) |>
  mutate(
    response_time_days = as.numeric(difftime(closed_date, created_date, units = "days")),
    year = year(created_date),
    month = month(created_date),
    weekday = wday(created_date, label = TRUE),
    complaint_category = case_when(
      str_detect(complaint_type, "Noise") ~ "Noise",
      str_detect(complaint_type, "Parking|Driveway") ~ "Parking",
      str_detect(complaint_type, "Sanitation|Condition") ~ "Sanitation",
      TRUE ~ "Other"
    )
  ) |>
  filter(response_time_days >= 0 & response_time_days <= 365) |>
  mutate(borough = str_to_title(borough))

cat("Cleaned 311 Data:\n")
cat("Rows after cleaning:", nrow(df_311_clean), "\n")
cat("Response time range:", round(range(df_311_clean$response_time_days, na.rm = TRUE), 2), "days\n")
```

# 3. Exploratory Data Analysis

## 3.1 Overall 311 Service Patterns

```{r eda-overview}
summary_stats <- df_311_clean |>
  summarise(
    total_requests = n(),
    avg_response_time = round(mean(response_time_days, na.rm = TRUE), 2),
    median_response_time = round(median(response_time_days, na.rm = TRUE), 2),
    sd_response_time = round(sd(response_time_days, na.rm = TRUE), 2)
  )

kable(summary_stats, caption = "Overall 311 Service Request Statistics")
```

### Complaint Type Distribution

```{r complaint-distribution}
complaint_dist <- df_311_clean |>
  count(complaint_category, sort = TRUE) |>
  mutate(percentage = round(n / sum(n) * 100, 1))

ggplot(complaint_dist, aes(x = reorder(complaint_category, n), y = n, fill = complaint_category)) +
  geom_col() +
  geom_text(aes(label = paste0(comma(n), " (", percentage, "%)")), hjust = -0.1) +
  coord_flip() +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Distribution of 311 Complaint Categories",
    subtitle = "January - April 2024",
    x = "Complaint Category",
    y = "Number of Requests"
  ) +
  theme_minimal() +
  theme(legend.position = "none", plot.title = element_text(face = "bold"))
```

### Top Specific Complaint Types

```{r top-complaints}
top_complaints <- df_311_clean %>%
  count(complaint_type, sort = TRUE) %>%
  head(15) %>%
  mutate(complaint_type = str_to_title(complaint_type))

ggplot(top_complaints, aes(x = reorder(complaint_type, n), y = n)) +
  geom_col(fill = "#2E86C1", width = 0.7) +
  geom_text(aes(label = comma(n)), hjust = -0.05, size = 3.5) +
  coord_flip(clip = "off") +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Top 15 Specific Complaint Types",
    subtitle = "January - April 2024",
    x = "Complaint Type",
    y = "Number of Complaints"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.margin = margin(10, 40, 10, 10)
  )
```

## 3.2 Geographic Distribution

### Complaints by Borough

```{r complaints-by-borough}
borough_summary <- df_311_clean %>%
  filter(!is.na(borough), borough != "Unspecified", borough != "") %>%
  group_by(borough) %>%
  summarise(count = n()) %>%
  arrange(desc(count))

# Use viridis color scale instead of manual to avoid color mismatch
ggplot(borough_summary, aes(x = count, y = reorder(borough, count), fill = borough)) +
  geom_col(width = 0.6, show.legend = FALSE) +
  geom_text(aes(label = comma(count)), hjust = -0.05, size = 4) +
  scale_fill_viridis_d(option = "mako", begin = 0.2, end = 0.9) +
  scale_x_continuous(labels = comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "311 Complaints by Borough",
    subtitle = "January - April 2024",
    x = "Number of Complaints",
    y = "Borough"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.margin = margin(10, 40, 10, 10)
  ) +
  coord_cartesian(clip = "off")
```

### Average Resolution Time by Borough

```{r resolution-by-borough, fig.height=6}
df_resolution <- df_311_clean %>%
  filter(!is.na(borough), borough != "Unspecified", !is.na(response_time_days))

borough_resolution <- df_resolution %>%
  group_by(borough) %>%
  summarise(avg_resolution_days = mean(response_time_days, na.rm = TRUE))

ggplot(borough_resolution, aes(x = reorder(borough, avg_resolution_days), y = avg_resolution_days)) +
  geom_point(size = 4, color = "#E74C3C") +
  geom_text(aes(label = round(avg_resolution_days, 1)), vjust = -0.8, size = 4) +
  labs(
    title = "Average Resolution Time by Borough",
    subtitle = "Days from creation to closure",
    x = "Borough",
    y = "Average Resolution Time (Days)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5)
  )
```

# 4. Research Question 1: Geographic Patterns in Response Times

**Researcher: Reem Hussein**

**Question:** What is the average response time to quality of life complaints by neighborhood?

## Analysis Approach

To understand geographic variation in 311 service delivery, we aggregated complaint data to the ZIP code level and calculated key response metrics including mean, median, and quartile response times.

```{r reem-setup}
# Clean ZIP codes and prepare data
nyc_311_clean <- df_311_clean %>%
  mutate(incident_zip = str_extract(incident_zip, "\\d{5}")) %>%
  filter(!is.na(incident_zip))

# Calculate ZIP level response metrics
response_by_zip <- nyc_311_clean %>%
  mutate(response_time_hours = response_time_days * 24) %>%
  group_by(incident_zip, borough) %>%
  summarize(
    n_complaints = n(),
    mean_response_days = mean(response_time_days, na.rm = TRUE),
    mean_response_hours = mean(response_time_hours, na.rm = TRUE),
    sd_response_days = sd(response_time_days, na.rm = TRUE),
    p25_days = quantile(response_time_days, 0.25, na.rm = TRUE),
    p75_days = quantile(response_time_days, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(mean_response_days))

cat("ZIP Code Analysis Summary:\n")
cat("Total ZIP codes:", nrow(response_by_zip), "\n")
cat("Response time range:", 
    round(range(response_by_zip$mean_response_days), 2), "days\n")
```

## Top 10 Slowest ZIP Codes

```{r reem-slowest}
datatable(
  response_by_zip %>%
    slice_max(mean_response_days, n = 10) %>%
    select(incident_zip, borough, n_complaints, mean_response_days),
  caption = "Top 10 Slowest ZIP Codes by Mean Response Time",
  colnames = c("ZIP", "Borough", "# Complaints", "Mean Days"),
  options = list(pageLength = 10, dom = 't'),
  rownames = FALSE
) %>%
  formatRound("mean_response_days", 2) %>%
  formatCurrency("n_complaints", "", 0, ",")
```

## Top 10 Fastest ZIP Codes

```{r reem-fastest}
datatable(
  response_by_zip %>%
    slice_min(mean_response_days, n = 10) %>%
    mutate(mean_response_hours = round(mean_response_hours, 2)) %>%
    select(incident_zip, borough, n_complaints, mean_response_hours),
  caption = "Top 10 Fastest ZIP Codes by Mean Response Time",
  colnames = c("ZIP", "Borough", "# Complaints", "Mean Hours"),
  options = list(pageLength = 10, dom = 't'),
  rownames = FALSE
) %>%
  formatRound("mean_response_hours", 2) %>%
  formatCurrency("n_complaints", "", 0, ",")
```

## Borough-Level Summary

```{r reem-borough-summary}
response_by_borough <- response_by_zip %>%
  group_by(borough) %>%
  summarize(
    n_zips = n(),
    total_complaints = sum(n_complaints),
    avg_mean_days = mean(mean_response_days, na.rm = TRUE),
    min_days = min(mean_response_days, na.rm = TRUE),
    max_days = max(mean_response_days, na.rm = TRUE),
    .groups = "drop"
  )

datatable(
  response_by_borough,
  caption = "Response Time Summary by Borough",
  colnames = c("Borough", "# ZIP Codes", "Total Complaints", "Avg Mean Days", "Min Days", "Max Days"),
  options = list(pageLength = 10),
  rownames = FALSE
) %>%
  formatRound(c("avg_mean_days", "min_days", "max_days"), 2) %>%
  formatCurrency(c("n_zips", "total_complaints"), "", 0, ",")
```

## Visualizations

```{r reem-viz-1}
response_by_zip %>%
  filter(n_complaints >= 30) %>%
  arrange(mean_response_days) %>%
  head(20) %>%
  ggplot(aes(x = reorder(incident_zip, mean_response_days), y = mean_response_days, fill = borough)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "20 Fastest ZIP Codes by Average Response Time",
    subtitle = "ZIP codes with 30+ complaints",
    x = "ZIP Code",
    y = "Average Response Time (days)",
    fill = "Borough"
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))
```

```{r reem-viz-2}
ggplot(response_by_borough, aes(x = reorder(borough, avg_mean_days), y = avg_mean_days, fill = borough)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Average Response Time by Borough",
    x = "Borough",
    y = "Average Response Time (days)"
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  theme(legend.position = "none", plot.title = element_text(face = "bold"))
```

## Key Findings (Reem)

The analysis reveals substantial geographic variation in 311 response times:

- **Staten Island** has the fastest average response times across ZIP codes
- **Brooklyn and Queens** account for the highest complaint volumes but show moderate response times
- Response times within boroughs vary considerably, with some ZIP codes experiencing delays 10+ times longer than the fastest areas
- The fastest ZIP codes resolve complaints in hours, while the slowest take days or weeks

# 5. Research Question 2: Income and Response Time Relationship

**Researcher: Hyacinthe Sarr**

**Question:** Is there a relationship between income levels and average 311 response times?

## Analysis Approach

To test whether wealthier neighborhoods experience systematically faster service, we merged ZIP level 311 response data with Census median household income data and examined the correlation between income and response time.

```{r sarr-setup}
# Prepare data with income
nyc_zip <- nyc_311_clean %>%
  group_by(zip_code = incident_zip) %>%
  summarise(
    avg_response = mean(response_time_days, na.rm = TRUE),
    median_response = median(response_time_days, na.rm = TRUE),
    n_complaints = n(),
    .groups = "drop"
  )

nyc_joined <- nyc_zip %>%
  left_join(nyc_income, by = "zip_code") %>%
  filter(!is.na(median_income))

cat("Analysis Dataset:\n")
cat("ZIP codes with income data:", nrow(nyc_joined), "\n")
cat("Income range: $", comma(range(nyc_joined$median_income)), "\n")
```

## Scatterplot: Income vs Response Time

```{r sarr-viz, fig.height=6}
ggplot(nyc_joined, aes(x = median_income, y = avg_response)) +
  geom_point(alpha = 0.6, color = "#0072B2") +
  geom_smooth(method = "lm", se = TRUE, color = "red", linewidth = 1.1) +
  labs(
    title = "Relationship Between Median Household Income and 311 Response Times",
    subtitle = "ZIP level comparison across NYC (Jan–Apr 2024)",
    x = "Median Household Income (USD)",
    y = "Average 311 Response Time (Days)"
  ) +
  scale_x_continuous(labels = dollar_format()) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))
```

## Statistical Analysis

```{r sarr-correlation}
cor_test <- cor.test(nyc_joined$median_income, nyc_joined$avg_response)

cat("Correlation Analysis:\n")
cat("Correlation coefficient:", round(cor_test$estimate, 4), "\n")
cat("P-value:", format.pval(cor_test$p.value, digits = 3), "\n")
cat("\nInterpretation:", 
    ifelse(abs(cor_test$estimate) < 0.3, "Weak", 
           ifelse(abs(cor_test$estimate) < 0.7, "Moderate", "Strong")), 
    "correlation\n")
```

```{r sarr-regression}
model <- lm(avg_response ~ median_income, data = nyc_joined)
summary_table <- tidy(model)

kable(summary_table, 
      caption = "Linear Regression: Response Time ~ Income",
      digits = 4)

cat("\nR-squared:", round(summary(model)$r.squared, 4), "\n")
cat("For every $10,000 increase in median income, response time changes by", 
    round(coef(model)[2] * 10000, 3), "days\n")
```

## Key Findings (Hyacinthe)

The analysis reveals a **weak relationship** between neighborhood income and 311 response times:

- Correlation coefficient is small (r ≈ -0.1 to -0.2), indicating minimal linear association
- Both low income and high income ZIP codes experience the full range of response times
- The regression line slopes slightly downward, suggesting marginally faster responses in wealthier areas, but the effect is tiny
- **Income alone explains less than 5% of variation** in response times (low R-squared)
- Vertical dispersion of points far exceeds any horizontal trend

**Conclusion:** Other factors such as complaint type, borough operations, infrastructure complexity, and resource allocation patterns likely play much larger roles than income in determining response times.

# 6. Research Question 3: Complaint Type and Wealth

**Researcher: Juan Jaimes**

**Question:** Do certain types of quality of life complaints get resolved faster in wealthier neighborhoods?

## Analysis Approach

To determine whether specific complaint categories are handled differently based on neighborhood wealth, we created wealth quintiles and compared response times across complaint types.

```{r juan-setup}
# Create wealth categories
df_juan <- df_311_clean %>%
  mutate(zip_code = incident_zip) %>%
  left_join(nyc_income, by = "zip_code") %>%
  filter(!is.na(median_income)) %>%
  mutate(
    wealth_quintile = ntile(median_income, 5),
    wealth_category = case_when(
      wealth_quintile %in% 1:2 ~ "Less Wealthy",
      wealth_quintile %in% 4:5 ~ "Wealthy",
      TRUE ~ "Middle"
    )
  ) %>%
  filter(wealth_category != "Middle")

# Calculate response times by complaint type and wealth
complaint_wealth <- df_juan %>%
  group_by(complaint_category, wealth_category) %>%
  summarise(
    avg_response_time = mean(response_time_days, na.rm = TRUE),
    request_count = n(),
    .groups = "drop"
  )

kable(complaint_wealth, 
      caption = "Response Times by Complaint Type and Wealth Category",
      digits = 2)
```

## Visualization: Response Times by Complaint and Wealth

```{r juan-viz-1}
ggplot(complaint_wealth, aes(x = complaint_category, y = avg_response_time, fill = wealth_category)) +
  geom_col(position = "dodge") +
  labs(
    title = "Response Times by Complaint Type and Wealth",
    subtitle = "Comparing wealthy vs. less wealthy neighborhoods",
    x = "Complaint Category",
    y = "Average Response Time (Days)",
    fill = "Neighborhood Type"
  ) +
  scale_fill_manual(values = c("Wealthy" = "#2ECC71", "Less Wealthy" = "#E74C3C")) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))
```

## Distribution of Response Times

```{r juan-viz-2}
set.seed(123)
expanded_data <- complaint_wealth %>%
  rowwise() %>%
  mutate(response_time = list(rnorm(n = 50, mean = avg_response_time, sd = 1.5))) %>%
  unnest(response_time)

ggplot(expanded_data, aes(x = complaint_category, y = response_time, fill = wealth_category)) +
  geom_boxplot(alpha = 0.7, outlier.alpha = 0.3) +
  labs(
    title = "Distribution of Complaint Resolution Times by Neighborhood Wealth",
    subtitle = "Simulated distributions based on observed means",
    x = "Complaint Category",
    y = "Response Time (Days)",
    fill = "Wealth Category"
  ) +
  scale_fill_manual(values = c("Wealthy" = "#2ECC71", "Less Wealthy" = "#E74C3C")) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))
```

## Gap Analysis

```{r juan-gap}
gap_data <- complaint_wealth %>%
  select(complaint_category, wealth_category, avg_response_time) %>%
  pivot_wider(names_from = wealth_category, values_from = avg_response_time) %>%
  mutate(gap = `Less Wealthy` - Wealthy)

ggplot(gap_data, aes(x = complaint_category, y = gap, group = 1)) +
  geom_line(linewidth = 1.2, color = "#E74C3C") +
  geom_point(size = 3, color = "#E74C3C") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(
    title = "Gap in Complaint Resolution Times by Complaint Type",
    subtitle = "Positive values indicate slower resolution in less wealthy neighborhoods",
    x = "Complaint Category",
    y = "Gap in Response Time (Days): Less Wealthy - Wealthy"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))
```

## Key Findings (Juan)

The analysis provides evidence of disparities in complaint resolution by neighborhood wealth:

- **All complaint categories** show longer average response times in less wealthy neighborhoods
- **Sanitation and "Other" complaints** show the largest gaps between wealthy and less wealthy areas
- The pattern is consistent across different complaint types, suggesting a systematic difference
- No complaint category shows faster service in less wealthy neighborhoods

**Interpretation:** Quality-of-life complaints are resolved more quickly in wealthier neighborhoods across all categories studied. The magnitude varies by complaint type, with some services showing larger wealth based disparities than others.

# 7. Research Question 4: Borough Level Disparities

**Researcher: Kyle Shaddox**

**Question:** Which boroughs or neighborhoods show the greatest disparities in 311 response times when compared by wealth?

This section presents key findings from Kyle's analysis. For the complete analysis with detailed methodology, bootstrap statistical inference, and interactive maps that let you explore patterns by borough and complaint type, see [Kyle's full individual report](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html).

## Analysis Approach and Methodology

Kyle employed a comprehensive analytical strategy combining spatial analysis, bootstrap statistical inference, and interactive visualization to examine borough level disparities. The methodology included several distinct components:

**Data Integration and Spatial Matching**

The analysis began by [linking 311 service requests with census tract income data](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html#spatial-join-to-link-complaints-with-income-data) through spatial joins, allowing for precise neighborhood level comparisons. This approach provides more granular analysis than ZIP code aggregation alone, matching each complaint to the census tract where it occurred and the corresponding median household income for that area.

**Statistical Testing Framework**

Rather than relying solely on visual comparisons, Kyle applied [bootstrap resampling methods with 10,000 iterations](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html#analytical-strategy-bootstrap-inference) to calculate confidence intervals for median response time differences between wealthy and poor neighborhoods. This robust statistical approach accounts for the heavily skewed distribution of response times and provides clear evidence of whether observed disparities exceed what random chance would produce. The bootstrap results showed that residents in the lowest income areas wait between 0.03 and 0.33 days longer than those in the highest income areas, with 95% confidence.

**Complaint Type Analysis**

The analysis breaks down disparities by specific complaint categories, revealing that [different types of 311 requests show varying levels of income based inequality](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html#looking-at-different-types-of-complaints). For example, noise complaints and illegal parking show disparity ratios above 1.25, meaning poor neighborhoods wait 25% longer, while emergency issues like heat and hot water show smaller gaps or even reverse patterns.

**Borough Specific Comparisons**

Each of the five boroughs received individual examination to identify [which areas show the most pronounced wealth based service gaps](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html#where-are-the-biggest-problems). Statistical tests confirmed that disparities vary substantially across boroughs, with some showing strong income effects and others showing minimal or reverse patterns.

**Interactive Dashboard**

To enable deeper exploration of the findings, Kyle created an [interactive dashboard with filterable maps and detailed statistical tables](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html#interactive-dashboard) that allow users to examine specific neighborhoods, time periods, and complaint types. The dashboard includes a color coded map showing response times across census tracts and comprehensive breakdowns by borough and income quartile.

## Key Findings

The analysis reveals substantial variation in how income relates to service delivery across different parts of New York City:

**Largest Disparities:** Brooklyn shows the most pronounced income based disparity, with low wealth neighborhoods waiting 86% longer than high wealth neighborhoods. Queens shows the second largest gap. These findings emerged from comparing median response times across income quartiles within each borough.

**Smallest Disparities:** Staten Island shows the smallest gap and actually exhibits a reverse pattern, with wealthier neighborhoods experiencing slightly longer wait times. This unexpected finding suggests that borough level administrative practices and resource allocation vary significantly across the city.

**Statistical Significance:** Bootstrap confidence intervals and traditional statistical tests confirm significant differences in Brooklyn, Queens, and Manhattan. The Bronx shows modest differences that, while present, are less pronounced than in Brooklyn.

**Complaint Type Patterns:** The [detailed breakdown by complaint type](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html#looking-at-different-types-of-complaints) shows that quality of life issues like noise and parking complaints exhibit larger disparities than emergency repairs. Heat and hot water complaints, which affect habitability, show smaller income based gaps, suggesting the city prioritizes these issues more equally.

**Neighborhood Outliers:** Specific census tracts show response times that deviate substantially from predictions based on income alone, suggesting localized operational issues that warrant targeted investigation.

For detailed statistical tests, regression models, complete data tables, and interactive visualizations that let you explore these patterns yourself, see [Kyle's complete analysis](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html).

# 8. Research Question 5: Predictive Modeling

**Researcher: Shahria Ahmed**

**Question:** Can we predict where a complaint came from (neighborhood/borough) based on the complaint characteristics?

## Motivation and Approach

The goal was to determine whether complaint characteristics carry distinct geographic signatures. If successful prediction is possible, it suggests that different neighborhoods face systematically different types of problems, which has implications for resource allocation.

### Model Evolution

The analysis went through three iterations:

1. **Initial Model (Jan-Apr 2024 data):** 38% accuracy
2. **Expanded Model (Full year stratified sample):** 39% accuracy
3. **Final Model (Satisfaction Survey data):** 45% accuracy

## Load Satisfaction Survey Data

```{r shahria-load-data}
data_file_satisfaction <- "nyc_311_satisfaction_survey.rds"

if (file.exists(data_file_satisfaction)) {
  df_satisfaction <- readRDS(data_file_satisfaction)
} else {
  base_url <- "https://data.cityofnewyork.us/resource/5ijn-vbdv.json"
  
  resp <- request(base_url) |>
    req_url_query(`$limit` = 500000) |>
    req_perform()
  
  df_satisfaction <- resp |> resp_body_json(simplifyVector = TRUE) |> as_tibble()
  saveRDS(df_satisfaction, data_file_satisfaction)
}

cat("Satisfaction survey data loaded:", nrow(df_satisfaction), "rows\n")
```

## Data Preparation

```{r shahria-prep}
# Function to convert satisfaction text to numeric
convert_satisfaction_to_numeric <- function(satisfaction_text) {
  case_when(
    grepl("Strongly Agree|Very Satisfied|Strongly Satisfied", satisfaction_text, ignore.case = TRUE) ~ 5,
    grepl("^Agree|^Satisfied", satisfaction_text, ignore.case = TRUE) ~ 4,
    grepl("Neutral|Neither", satisfaction_text, ignore.case = TRUE) ~ 3,
    grepl("Dissatisfied|^Disagree", satisfaction_text, ignore.case = TRUE) ~ 2,
    grepl("Strongly Disagree|Strongly Dissatisfied|Very Dissatisfied", satisfaction_text, ignore.case = TRUE) ~ 1,
    TRUE ~ NA_real_
  )
}

# Prepare modeling dataset
df_model_satisfaction <- df_satisfaction %>%
  filter(!is.na(borough), borough != "Unspecified", borough != "") %>%
  filter(!is.na(overall_satisfaction)) %>%
  mutate(
    satisfaction_score = convert_satisfaction_to_numeric(overall_satisfaction),
    year = as.numeric(year),
    month = as.numeric(month)
  ) %>%
  filter(!is.na(satisfaction_score))

# Check if required packages are installed
required_packages <- c("randomForest", "caret", "forcats")
for(pkg in required_packages) {
  if(!require(pkg, character.only = TRUE, quietly = TRUE)) {
    install.packages(pkg)
    library(pkg, character.only = TRUE)
  }
}
```

## Borough Distribution

```{r shahria-borough-dist}
borough_table <- as.data.frame(table(df_model_satisfaction$borough))
colnames(borough_table) <- c("Borough", "Count")

ggplot(borough_table %>% arrange(desc(Count)), 
       aes(x = reorder(Borough, Count), y = Count, fill = Borough)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = comma(Count)), hjust = -0.1) +
  coord_flip() +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Complaint Distribution by Borough in Satisfaction Survey",
    x = "Borough",
    y = "Count of Complaints"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))
```

## Build Random Forest Model

```{r shahria-model}
set.seed(123)

# Prepare final dataset
df_final <- df_model_satisfaction %>%
  mutate(
    complaint_type = fct_lump_n(as.factor(complaint_type), n = 50),
    descriptor = fct_lump_n(as.factor(descriptor), n = 50),
    agency = as.factor(agency),
    dissatisfaction_reason = fct_lump_n(as.factor(dissatisfaction_reason), n = 50),
    borough = as.factor(borough)
  ) %>%
  select(borough, satisfaction_score, complaint_type, descriptor, agency,
         dissatisfaction_reason, year, month) %>%
  drop_na()

# Split into training and test sets
train_index <- createDataPartition(df_final$borough, p = 0.8, list = FALSE)
train_data <- df_final[train_index, ]
test_data <- df_final[-train_index, ]

# Train Random Forest model
rf_model <- randomForest(
  borough ~ .,
  data = train_data,
  ntree = 100,
  importance = TRUE,
  na.action = na.omit
)

# Make predictions
predictions <- predict(rf_model, test_data)
confusion_matrix <- confusionMatrix(predictions, test_data$borough)

cat("Model Performance:\n")
cat("Overall Accuracy:", round(confusion_matrix$overall['Accuracy'] * 100, 2), "%\n")
cat("Baseline (random guessing):", round(100 / length(unique(df_final$borough)), 2), "%\n")
```

## Model Evaluation

```{r shahria-confusion}
confusion_df <- as.data.frame.matrix(confusion_matrix$table)
confusion_df <- cbind(Predicted = rownames(confusion_df), confusion_df)
numeric_cols <- colnames(confusion_df)[colnames(confusion_df) != "Predicted"]

datatable(confusion_df, 
          options = list(pageLength = 10, dom = 't', scrollX = TRUE),
          caption = "Confusion Matrix: Predicted vs Actual Borough",
          rownames = FALSE) %>% 
  formatCurrency(numeric_cols, currency = "", interval = 3, mark = ",", digits = 0)
```

## Feature Importance

```{r shahria-importance}
importance_df <- importance(rf_model) %>%
  as.data.frame() %>%
  tibble::rownames_to_column("Feature") %>%
  arrange(desc(MeanDecreaseGini))

ggplot(importance_df, aes(x = reorder(Feature, MeanDecreaseGini), y = MeanDecreaseGini)) +
  geom_col(fill = "#0D0887") +
  coord_flip() +
  labs(
    title = "Feature Importance for Borough Prediction",
    subtitle = "Higher values indicate greater predictive power",
    x = "Feature",
    y = "Importance Score (Mean Decrease Gini)"
  ) +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold"))
```

## Top Complaints by Borough

```{r shahria-top-complaints}
top_complaints_by_borough <- df_final %>%
  group_by(borough, complaint_type) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(borough) %>%
  slice_max(order_by = count, n = 3) %>%
  ungroup() %>%
  arrange(borough, desc(count))

ggplot(top_complaints_by_borough, 
       aes(x = reorder(borough, -count), y = count, fill = complaint_type)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Top 3 Complaint Types by Borough",
    x = "Borough",
    y = "Number of Complaints",
    fill = "Complaint Type"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "bottom"
  )
```

## Key Findings (Shahria)

**Model Accuracy:** The Random Forest classifier achieved **45.26% accuracy**, well above the 20% baseline of random guessing, indicating that complaint characteristics do carry geographic signatures.

**Most Important Features:**
1. **Descriptor** – Most predictive feature
2. **Complaint Type** – Second most important
3. **Agency** and **Dissatisfaction Reason** – Moderate importance

**Geographic Patterns:**
- Brooklyn and Queens are dominated by **illegal parking** complaints
- Manhattan shows more **noise** and **building-related** complaints
- Different boroughs face systematically different types of problems

**Implications:** The model's ability to predict borough suggests that resource allocation should be tailored to local complaint patterns rather than using a one size fits all approach.

# 9. Synthesis and Conclusions

## Summary of Key Findings

**Finding 1: Geographic Variation is Large, Income Effects are Small**

Response times vary dramatically across NYC—from under one hour to over 100 hours at the ZIP code level. However, neighborhood income explains very little of this variation. Both wealthy and low income neighborhoods experience the full range of response times. Regression analysis confirms a weak negative correlation, with income accounting for less than 5% of variation in response times.

**Finding 2: Complaint Type Matters More Than Income**

Different complaint types show different response patterns, and different neighborhoods generate different types of complaints. Machine learning analysis confirms that complaint characteristics are more predictive of location than timing or satisfaction metrics. This suggests that operational factors and problem complexity drive outcomes more than wealth based discrimination.

**Finding 3: Borough Level Disparities Are Uneven**

Brooklyn shows the largest income based disparity, with residents in low wealth neighborhoods waiting 86% longer than those in high wealth areas. Queens shows the second largest gap. In contrast, Staten Island shows a reverse pattern where wealthier neighborhoods experience slightly longer wait times. These borough specific differences, documented through [bootstrap statistical analysis and interactive mapping](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html#where-are-the-biggest-problems), suggest that local administrative practices, resource allocation, and infrastructure vary significantly across the city. The [detailed complaint type breakdown](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html#looking-at-different-types-of-complaints) reveals that quality of life issues show larger disparities than emergency repairs, indicating the city may prioritize habitability concerns more equally across income levels.

**Finding 4: Specific Neighborhoods Deviate from Expectations**

Some ZIP codes experience response times that are substantially longer or shorter than predicted by income alone. These outliers highlight localized operational issues that require targeted investigation.

## Relationship to Prior Research

This study aligns with prior research showing that 311 service disparities exist but are not driven solely by simple income discrimination. Studies in other cities have documented similar patterns where multiple factors—resource allocation, complaint articulation, infrastructure complexity—interact to produce uneven service delivery.

Our findings challenge a straightforward narrative of bias while identifying specific areas where targeted intervention is warranted. High complaint volumes in lower income neighborhoods suggest that access barriers do not fully prevent engagement with 311, though unreported issues remain a concern.

## Policy Implications

**Immediate Recommendations:**

1. **Monitor borough level disparities** – Implement real time tracking of response times by income quartile within each borough. The [interactive dashboard developed for this analysis](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html#interactive-dashboard) demonstrates how such monitoring tools could work in practice.
2. **Investigate Brooklyn's disparities** – Focus resources on understanding why low wealth Brooklyn neighborhoods experience such long delays. [Detailed statistical analysis](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html#where-are-the-biggest-problems) shows this borough has the most pronounced income based gaps.
3. **Tailor resource allocation** – Different boroughs face different complaint types; uniform strategies may be inefficient
4. **Address specific neighborhood outliers** – Investigate the census tracts that deviate substantially from predictions based on income alone

**Long-term Strategies:**

1. **Develop equity metrics** – Create standardized measures for tracking service delivery fairness
2. **Improve complaint type-specific protocols** – Optimize response strategies for different types of issues
3. **Enhance community engagement** – Ensure all residents can effectively report and follow up on complaints
4. **Transparent reporting** – Publish regular equity reports to maintain accountability

## Study Limitations

- **Temporal scope:** Four-month winter period may not reflect year round patterns
- **Reporting bias:** Only captures complaints residents choose to file
- **Geographic aggregation:** ZIP codes mask within neighborhood variation
- **Service quality:** Response time is imperfect proxy for resolution effectiveness
- **Causal inference:** Observational design cannot definitively establish causation

## Future Research Directions

1. **Longer time periods** – Examine trends over multiple years and seasons
2. **Service quality integration** – Combine response time with satisfaction and resolution effectiveness
3. **Qualitative research** – Interview residents about reporting barriers and experiences
4. **Causal analysis** – Implement quasi-experimental designs to test interventions
5. **Additional sociodemographic factors** – Include race, language, tenure, and other variables

## Final Conclusion

Does New York City provide faster 311 service to wealthy neighborhoods? The answer is nuanced.

At the city wide level, income alone explains very little variation in response times. Both wealthy and lower income neighborhoods experience fast resolutions and long delays. However, important disparities emerge at the borough and neighborhood levels. [Detailed borough by borough analysis](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html#where-are-the-biggest-problems) shows that some areas consistently wait longer than expected, and certain complaint types show wealth based differences in resolution time.

Rather than indicating widespread discrimination, the data highlight opportunities for targeted improvements. Borough specific strategies, complaint type focused resource allocation, and attention to outlier neighborhoods can move the city toward more equitable service delivery. The [interactive tools and statistical methods](https://shaddokd.github.io/STA9750-2025-FALL/GI01.html#interactive-dashboard) developed in this analysis provide a model for ongoing monitoring and evaluation.

The 311 system plays a crucial role in New York City's governance. Ensuring that all residents—regardless of income or location—receive timely and effective responses to quality of life concerns is essential for public trust, neighborhood stability, and urban equity. This analysis provides a roadmap for identifying where improvements are needed and what types of interventions may be most effective.

# References

1. NYC Open Data. (2024). *311 Service Requests from 2010 to Present*. Retrieved from https://data.cityofnewyork.us/Social-Services/311-Service-Requests-from-2010-to-Present/erm2-nwe9/

2. NYC Open Data. (2024). *311 Resolution Satisfaction Survey*. Retrieved from https://data.cityofnewyork.us/City-Government/311-Resolution-Satisfaction-Survey/5ijn-vbdv

3. U.S. Census Bureau. (2024). *American Community Survey 5-Year Estimates*. Retrieved from https://www.census.gov/programs-surveys/acs

4. [Additional literature citations to be added based on specific papers cited in literature review]

---

## Appendix: Technical Notes

### Software and Packages

This analysis was conducted in R (version 4.x) using the following packages:

- Data manipulation: `tidyverse`, `dplyr`, `tidyr`
- Web APIs: `httr2`, `jsonlite`
- Visualization: `ggplot2`, `plotly`, `viridis`, `patchwork`
- Tables: `DT`, `knitr`
- Dates: `lubridate`
- Machine learning: `randomForest`, `caret`
- Statistical analysis: `broom`, `corrplot`

### Data Access

All datasets used in this analysis are publicly available through NYC Open Data and the U.S. Census Bureau. Code for data acquisition and processing is included in this document.

### Reproducibility

To reproduce this analysis:

1. Install required R packages
2. Run code chunks in order
3. Data files will be cached locally after first download
4. Set `cache = FALSE` in chunk options to force re-download

### Contact

For questions about this analysis:
- Kyle Shaddox, Reem Hussein, Hyacinthe Sarr, Juan Jaimes, Shahria Ahmed
- STA 9750 Final Project


---

*Document generated using Quarto on `r Sys.Date()`*
